{"version":3,"sources":["../src/editor_page.js"],"names":["dragged","nodes","draggedIndex","isSuccess","EditorInput","input","parent","textarea","addEventListener","rawInput","setAttribute","classList","add","errorDiv","document","createElement","appendChild","mathInput","value","latex","closest","length","parentElement","children","forEach","element","remove","dispatchEvent","Event","VisualMath","Input","EditorControl","name","text","onClick","command","id","event","target","Array","from","parentNode","indexOf","dataTransfer","setData","dropEffect","querySelector","style","opacity","getElementById","replaceWith","Control","EditorControlList","wrapper","buttonMathInput","expressionMathInput","mathquillExpression","__controller","container","mathquillExpressionString","outerHTML","addControl","Date","now","html","control","write","controls","enable","boundInput","bindInput","append","ControlList","initialize","templateId","templateName","managerPath","EditorPage","initInputFields","initControlsWrapper","initAddForm","initDeleteButton","addSubmitButtonEventListener","testRawInput","buttonRawInput","expressionRawInput","vmiTest","display","change","testMathInput","vmiButton","addClass","vmiExpression","controlsWrapper","preventDefault","clearData","targetId","contains","lastChild","nodeName","targetIndex","empty","removeChild","insertBefore","nextSibling","addButton","vmiTestAndSaveContainer","textContent","stopPropagation","template","addAll","bind","notification","addNotification","message","type","deleteIcon","firstElementChild","placeholder","submitBtn","data","items","querySelectorAll","push","button","expression","buttonsString","JSON","stringify","hiddenElem"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @module     qtype_shortmath/view-editor\n * @package    qtype_shortmath\n * @author     Simen Wiik <simenwiik@hotmail.com>\n * @author     Andr√© Storhaug <andr3.storhaug@gmail.com>\n * @copyright  2018 NTNU\n */\n\nimport notification from \"core/notification\";\nimport { getShortmathTemplate } from \"qtype_shortmath/api_helpers\";\nimport VisualMath from \"qtype_shortmath/visual-math-input\";\n\nlet lastFocusedInput = null;\nlet dragged;\nlet nodes;\nlet draggedIndex;\nlet isSuccess = true;\n\n/**\n * An EditorInput represents a collection of two items:\n * \n * 1. HTMLInputElement - shows the evaluated latex \n * 2. MathQuill field  - visual representation of math expressions\n */\nclass EditorInput extends VisualMath.Input {\n\n    constructor(input, parent) {\n        super(input, parent);\n        // textarea inherited from VisualMath.Input\n        this.textarea.addEventListener(\"focusout\", () => {\n            lastFocusedInput = this;\n        });\n        this.rawInput.setAttribute(\"required\", true);\n        this.rawInput.classList.add(\"form-control\");\n        let errorDiv = document.createElement(\"div\");\n        errorDiv.classList.add(\"invalid-feedback\", \"text-nowrap\");\n        this.parent.appendChild(errorDiv);\n    }\n\n    change() {\n        super.onEdit = (rawInput, mathInput) => {\n            rawInput.value = mathInput.latex();\n            if (!isSuccess && rawInput.closest(\".test-box\") !== null) {\n                if (rawInput.value.length === 0) {\n                    rawInput.parentElement.children.forEach(element => {\n                        element.classList.remove(\"form-control\", \"is-valid\");\n                        element.classList.add(\"form-control\", \"is-invalid\");\n                    });\n                } else {\n                    rawInput.parentElement.children.forEach(element => {\n                        element.classList.remove(\"form-control\", \"is-invalid\");\n                        element.classList.add(\"form-control\", \"is-valid\");\n                    });\n                }\n            }\n            rawInput.dispatchEvent(new Event(\"change\"));\n        };\n    }\n}\n\nclass EditorControl extends VisualMath.Control {\n\n    constructor(name, text, onClick, command) {\n        super(name, text, onClick);\n        this.command = command;\n    }\n\n    enable() {\n        super.enable();\n\n        this.element.id = this.name;\n        this.element.setAttribute(\"draggable\", true);\n\n        this.element.addEventListener(\"dragstart\", event => {\n            dragged = event.target;\n            nodes = Array.from(dragged.parentNode.children); //buttons on the control list\n            draggedIndex = nodes.indexOf(dragged);\n            // Add the target element's id to the data transfer object\n            event.dataTransfer.setData(\"text\", event.target.id);\n            event.dataTransfer.dropEffect = \"move\";\n            // event.target.style.opacity = 0.5;\n            document.querySelector(\".delete-box\").classList.remove(\"d-none\");\n        });\n\n        this.element.addEventListener(\"dragend\", event => {\n            event.target.style.opacity = \"\";\n            //document.querySelector(\":focus\").blur();\n            if (document.getElementById(\"placeholder\") !== null) {\n                document.getElementById(\"placeholder\").replaceWith(dragged);\n            }\n            document.querySelector(\".delete-box\").classList.add(\"d-none\");\n        });\n    }\n}\n\nclass EditorControlList extends VisualMath.ControlList {\n\n    constructor(wrapper) {\n        super(wrapper);\n    }\n\n    /**\n     * Add buttons to toolbar.\n     *\n     * @param buttonMathInput\n     * @param expressionMathInput\n     * @returns {boolean}\n     */\n    add(buttonMathInput, expressionMathInput) {\n        const mathquillExpression = buttonMathInput.__controller.container[0].querySelector(\".mq-root-block\");\n        const mathquillExpressionString = mathquillExpression.outerHTML;\n        this.addControl(\"btn_\" + Date.now(), mathquillExpressionString, expressionMathInput.latex());\n        return true;\n    }\n\n    addAll(value) {\n        let name = value[\"name\"];\n        let html = value[\"button\"];\n        let command = value[\"expression\"];\n        this.addControl(name, html, command);\n    }\n\n    addControl(name, html, command) {\n        let control = new EditorControl(name, html, mathInput => mathInput.write(command), command);\n        this.controls[name] = control;\n        control.enable();\n        if (this.boundInput !== null) {\n            control.bindInput(this.boundInput);\n        }\n        this.wrapper.append(control.element);\n    }\n}\n\n/**\n * Set up the page.\n *\n * @method init\n * @param {string} importIdString the string ID of the import.\n */\nexport const initialize = function (templateId, templateName, managerPath) {\n    let editorPage = new EditorPage(templateId, templateName, managerPath);\n};\n\n/**\n * Entry point of this file. All the parameters come from view_editor.php at $PAGE->requires->js_call_amd\n */\n// \"test\", \"btn\", \"exp\", 0, \"\", \"/question/type/shortmath/editor_action.php\", \"/question/type/shortmath/editor_manager.php\"\nclass EditorPage {\n\n    constructor(templateId, templateName) {\n        this.templateId = templateId;\n        this.templateName = templateName;\n\n        this.initInputFields();\n        this.initControlsWrapper();\n        this.initAddForm();\n        this.initDeleteButton();\n        this.addSubmitButtonEventListener();\n    }\n\n    vmiButton; // EditorControl object\n    buttonRawInput; // Raw HTMLInputElement\n    buttonMathInput; // MathQuill field\n    vmiExpression;\n    expressionRawInput;\n    expressionMathInput;\n    vmiTest;\n    testRawInput;\n    testMathInput;\n    controlsWrapper;\n    vmiTestAndSaveContainer; // Container for testing the buttons for this template\n    target;\n    controls;\n\n    /**\n     * Shortmath input fields\n     */\n    initInputFields() {\n        this.testRawInput = document.querySelector(\"#id_mqtest\");\n        this.buttonRawInput = document.querySelector(\"#id_mqbtntext\");\n        this.expressionRawInput = document.querySelector(\"#id_mqexpression\");\n        // Remove class \"d-inline\" added in shortanswer renderer class, which prevents input from being hidden.\n        this.testRawInput.classList.remove(\"d-inline\");\n\n        this.vmiTest = new EditorInput(this.testRawInput, this.testRawInput.closest('div'));\n        this.vmiTest.rawInput.style.display = \"none\";\n        this.vmiTest.change();\n        this.testMathInput = this.vmiTest.mathInput;\n\n        if (this.testRawInput.value) {\n            this.testMathInput.write(\n                this.testRawInput.value\n            );\n        }\n\n        // Remove class \"d-inline\" added in shortanswer renderer class, which prevents input from being hidden.\n        this.buttonRawInput.classList.remove(\"d-inline\");\n\n        this.vmiButton = new EditorInput(this.buttonRawInput, this.buttonRawInput.closest('div'));\n        this.vmiButton.rawInput.style.display = \"none\";\n        this.vmiButton.addClass('shortmath-blue');\n        this.vmiButton.change();\n        this.buttonMathInput = this.vmiButton.mathInput;\n\n        // Remove class \"d-inline\" added in shortanswer renderer class, which prevents input from being hidden.\n        this.expressionRawInput.classList.remove(\"d-inline\");\n        this.vmiExpression = new EditorInput(this.expressionRawInput, this.expressionRawInput.closest('div'));\n        this.vmiExpression.rawInput.style.display = \"none\";\n        this.vmiExpression.change();\n        this.expressionMathInput = this.vmiExpression.mathInput;\n\n    };\n\n    /**\n     * Wrapper for toolbar and drag and drop functionality for buttons\n     */\n    initControlsWrapper() {\n        this.controlsWrapper = document.querySelector(\".controlswrapper\");\n        this.controlsWrapper.addEventListener(\"drop\", event => {\n            event.preventDefault();\n\n            if (this.target.id === dragged.id) {\n                event.dataTransfer.clearData();\n                return;\n            }\n\n            document.getElementById(\"placeholder\").replaceWith(dragged);\n            event.dataTransfer.clearData();\n        });\n\n        this.controlsWrapper.addEventListener(\"dragover\", event => {\n            event.preventDefault();\n            event.dataTransfer.dropEffect = \"move\";\n        });\n\n        this.controlsWrapper.addEventListener(\"dragenter\", event => {\n\n            let targetId;\n            if (event.target.classList.contains(\"visual-math-input-wrapper\")) {\n                targetId = event.target.lastChild.id;\n            } else if (event.target.nodeName !== \"BUTTON\") {\n                targetId = event.target.closest(\"button\").id;\n            } else {\n                targetId = event.target.id;\n            }\n\n            if (targetId === \"placeholder\") {\n                return;\n            }\n\n            this.target = document.getElementById(targetId);\n\n            let targetIndex = nodes.indexOf(this.target);\n            if (draggedIndex === targetIndex) { //movement within button\n                return;\n            }\n\n            let empty = document.createElement(\"button\");\n            empty.id = \"placeholder\";\n            empty.classList.add(\"visual-math-input-control\", \"mq-math-mode\", \"btn\", \"btn-primary\");\n            empty.setAttribute(\"draggable\", true);\n            if (this.target.parentNode.contains(dragged)) {\n                this.target.parentNode.removeChild(dragged);\n            } else {\n                this.target.parentNode.removeChild(document.getElementById(\"placeholder\"));\n            }\n\n            if (draggedIndex < targetIndex) {\n                if (this.target.parentNode.lastChild !== this.target) {\n                    this.target.parentNode.insertBefore(empty, this.target.nextSibling); //left to right\n                } else {\n                    this.target.parentNode.appendChild(empty);\n                }\n            } else {\n                this.target.parentNode.insertBefore(empty, this.target); //right to left\n            }\n\n            nodes = Array.from(this.target.parentNode.children);\n            draggedIndex = nodes.indexOf(empty);\n        });\n    };\n\n    /**\n     * To add buttons to toolbar in create mode/load buttons in edit mode\n     */\n    async initAddForm() {\n        const addButton = document.querySelector(\"#id_mqaddbutton\");\n\n        this.vmiTestAndSaveContainer = document.querySelector(\".test-box\");\n        this.controls = new EditorControlList(this.controlsWrapper);\n        this.controls.bindInput(this.vmiTest);\n        this.vmiButton.parent.querySelector(\".invalid-feedback\").textContent = \"Button is empty or invalid!\";\n        this.vmiExpression.parent.querySelector(\".invalid-feedback\").textContent = \"Expression is empty or invalid!\";\n\n        addButton.addEventListener(\"click\", event => {\n            event.preventDefault();\n            event.stopPropagation();\n            this.isSuccess = this.controls.add(this.buttonMathInput, this.expressionMathInput);\n            if (isSuccess) {\n                //Clear inputs\n                this.buttonMathInput.latex(\"\");\n                this.expressionMathInput.latex(\"\");\n            }\n        });\n\n        if (this.templateId > 0) {\n            try {\n                const template = await getShortmathTemplate(this.templateId);\n                template.forEach(this.controls.addAll.bind(this.controls));\n            } catch (error) {\n                notification.addNotification({\n                    message: error,\n                    type: \"error\"\n                });\n            }\n        }\n    };\n\n    /**\n     * To delete buttons from toolbar\n     */\n    async initDeleteButton() {\n        let deleteIcon = document.querySelector(\".delete-icon\");\n\n        deleteIcon.addEventListener(\"dragover\", event => {\n            event.preventDefault();\n            event.dataTransfer.dropEffect = \"move\";\n        });\n\n        deleteIcon.addEventListener(\"drop\", event => {\n            event.preventDefault();\n            let parentNode = dragged.parentNode;\n            if (parentNode !== null) {\n                parentNode.removeChild(dragged);\n                if (parentNode.firstElementChild === null) {\n                    this.testMathInput.latex(\"\");\n                }\n            } else {\n                let placeholder = document.getElementById(\"placeholder\");\n                if (placeholder !== null) {\n                    placeholder.parentNode.removeChild(placeholder);\n                }\n            }\n            event.dataTransfer.clearData();\n        });\n    };\n\n    addSubmitButtonEventListener() {\n        const submitBtn = document.querySelector(\"#id_submitbutton\");\n        submitBtn.addEventListener(\"click\", event => {\n            let data = [];\n            let items = this.controls.controls;\n            this.controlsWrapper.querySelectorAll(\"button\").forEach(element => {\n                let control = items[element.id];\n                data.push({\n                    name: control[\"name\"],\n                    button: control[\"text\"],\n                    expression: control[\"command\"]\n                });\n            });\n            const buttonsString = JSON.stringify(data);\n            const hiddenElem = document.querySelector('[name=\"templatestring\"]');\n            hiddenElem.value = buttonsString;\n        });\n    };\n}\n"],"file":"editor_page.min.js"}