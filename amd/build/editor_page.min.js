define ("qtype_shortmath/editor_page",["exports","core/notification","qtype_shortmath/api_helpers","qtype_shortmath/visual-math-input"],function(a,b,c,d){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.initialize=void 0;b=e(b);d=e(d);function e(a){return a&&a.__esModule?a:{default:a}}function f(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function g(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var i=a.apply(b,c);function g(a){f(i,d,e,g,h,"next",a)}function h(a){f(i,d,e,g,h,"throw",a)}g(void 0)})}}function h(a,b,c){if("undefined"!=typeof Reflect&&Reflect.get){h=Reflect.get}else{h=function(a,b,c){var d=p(a,b);if(!d)return;var e=Object.getOwnPropertyDescriptor(d,b);if(e.get){return e.get.call(c)}return e.value}}return h(a,b,c||a)}function i(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){i=function(a){return typeof a}}else{i=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return i(a)}function j(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function k(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function l(a,b,c){if(b)k(a.prototype,b);if(c)k(a,c);return a}function m(a,b,c,d){if("undefined"!=typeof Reflect&&Reflect.set){m=Reflect.set}else{m=function(a,b,c,d){var e=p(a,b),f;if(e){f=Object.getOwnPropertyDescriptor(e,b);if(f.set){f.set.call(d,c);return!0}else if(!f.writable){return!1}}f=Object.getOwnPropertyDescriptor(d,b);if(f){if(!f.writable){return!1}f.value=c;Object.defineProperty(d,b,f)}else{o(d,b,c)}return!0}}return m(a,b,c,d)}function n(a,b,c,d,e){var f=m(a,b,c,d||a);if(!f&&e){throw new Error("failed to set property")}return c}function o(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}function p(a,b){while(!Object.prototype.hasOwnProperty.call(a,b)){a=w(a);if(null===a)break}return a}function q(a,b){if("function"!=typeof b&&null!==b){throw new TypeError("Super expression must either be null or a function")}a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}});if(b)r(a,b)}function r(a,b){r=Object.setPrototypeOf||function(a,b){a.__proto__=b;return a};return r(a,b)}function s(a){return function(){var b=w(a),c;if(v()){var d=w(this).constructor;c=Reflect.construct(b,arguments,d)}else{c=b.apply(this,arguments)}return t(this,c)}}function t(a,b){if(b&&("object"===i(b)||"function"==typeof b)){return b}return u(a)}function u(a){if(void 0===a){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return a}function v(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return!0}catch(a){return!1}}function w(a){w=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)};return w(a)}var x,y,z,A=!0,B=function(a){q(b,a);var c=s(b);function b(a,d){var e;j(this,b);e=c.call(this,a,d);e.textarea.addEventListener("focusout",function(){u(e)});e.rawInput.setAttribute("required",!0);e.rawInput.classList.add("form-control");var f=document.createElement("div");f.classList.add("invalid-feedback","text-nowrap");e.parent.appendChild(f);return e}l(b,[{key:"change",value:function change(){n(w(b.prototype),"onEdit",function(a,b){a.value=b.latex();if(!A&&null!==a.closest(".test-box")){if(0===a.value.length){a.parentElement.children.forEach(function(a){a.classList.remove("form-control","is-valid");a.classList.add("form-control","is-invalid")})}else{a.parentElement.children.forEach(function(a){a.classList.remove("form-control","is-invalid");a.classList.add("form-control","is-valid")})}}a.dispatchEvent(new Event("change"))},this,!0)}}]);return b}(d.default.Input),C=function(a){q(b,a);var c=s(b);function b(a,d,e,f){var g;j(this,b);g=c.call(this,a,d,e);g.command=f;return g}l(b,[{key:"enable",value:function enable(){h(w(b.prototype),"enable",this).call(this);this.element.id=this.name;this.element.setAttribute("draggable",!0);this.element.addEventListener("dragstart",function(a){x=a.target;y=Array.from(x.parentNode.children);z=y.indexOf(x);a.dataTransfer.setData("text",a.target.id);a.dataTransfer.dropEffect="move";document.querySelector(".delete-box").classList.remove("d-none")});this.element.addEventListener("dragend",function(a){a.target.style.opacity="";if(null!==document.getElementById("placeholder")){document.getElementById("placeholder").replaceWith(x)}document.querySelector(".delete-box").classList.add("d-none")})}}]);return b}(d.default.Control),D=function(a){q(b,a);var c=s(b);function b(a){j(this,b);return c.call(this,a)}l(b,[{key:"add",value:function add(a,b){var c=a.__controller.container[0].querySelector(".mq-root-block"),d=c.outerHTML;this.addControl("btn_"+Date.now(),d,b.latex());return!0}},{key:"addAll",value:function addAll(a){var b=a.name,c=a.button,d=a.expression;this.addControl(b,c,d)}},{key:"addControl",value:function addControl(a,b,c){var d=new C(a,b,function(a){return a.write(c)},c);this.controls[a]=d;d.enable();if(null!==this.boundInput){d.bindInput(this.boundInput)}this.wrapper.append(d.element)}}]);return b}(d.default.ControlList);a.initialize=function initialize(a,b,c){new E(a,b,c)};var E=function(){function a(b,c){j(this,a);o(this,"vmiButton",void 0);o(this,"buttonRawInput",void 0);o(this,"buttonMathInput",void 0);o(this,"vmiExpression",void 0);o(this,"expressionRawInput",void 0);o(this,"expressionMathInput",void 0);o(this,"vmiTest",void 0);o(this,"testRawInput",void 0);o(this,"testMathInput",void 0);o(this,"controlsWrapper",void 0);o(this,"vmiTestAndSaveContainer",void 0);o(this,"target",void 0);o(this,"controls",void 0);this.templateId=b;this.templateName=c;this.initInputFields();this.initControlsWrapper();this.initAddForm();this.initDeleteButton();this.addSubmitButtonEventListener()}l(a,[{key:"initInputFields",value:function initInputFields(){this.testRawInput=document.querySelector("#id_mqtest");this.buttonRawInput=document.querySelector("#id_mqbtntext");this.expressionRawInput=document.querySelector("#id_mqexpression");this.testRawInput.classList.remove("d-inline");this.vmiTest=new B(this.testRawInput,this.testRawInput.closest("div"));this.vmiTest.rawInput.style.display="none";this.vmiTest.change();this.testMathInput=this.vmiTest.mathInput;if(this.testRawInput.value){this.testMathInput.write(this.testRawInput.value)}this.buttonRawInput.classList.remove("d-inline");this.vmiButton=new B(this.buttonRawInput,this.buttonRawInput.closest("div"));this.vmiButton.rawInput.style.display="none";this.vmiButton.addClass("shortmath-blue");this.vmiButton.change();this.buttonMathInput=this.vmiButton.mathInput;this.expressionRawInput.classList.remove("d-inline");this.vmiExpression=new B(this.expressionRawInput,this.expressionRawInput.closest("div"));this.vmiExpression.rawInput.style.display="none";this.vmiExpression.change();this.expressionMathInput=this.vmiExpression.mathInput}},{key:"initControlsWrapper",value:function initControlsWrapper(){var a=this;this.controlsWrapper=document.querySelector(".controlswrapper");this.controlsWrapper.addEventListener("drop",function(b){b.preventDefault();if(a.target.id===x.id){b.dataTransfer.clearData();return}document.getElementById("placeholder").replaceWith(x);b.dataTransfer.clearData()});this.controlsWrapper.addEventListener("dragover",function(a){a.preventDefault();a.dataTransfer.dropEffect="move"});this.controlsWrapper.addEventListener("dragenter",function(b){var c;if(b.target.classList.contains("visual-math-input-wrapper")){c=b.target.lastChild.id}else if("BUTTON"!==b.target.nodeName){c=b.target.closest("button").id}else{c=b.target.id}if("placeholder"===c){return}a.target=document.getElementById(c);var d=y.indexOf(a.target);if(z===d){return}var e=document.createElement("button");e.id="placeholder";e.classList.add("visual-math-input-control","mq-math-mode","btn","btn-primary");e.setAttribute("draggable",!0);if(a.target.parentNode.contains(x)){a.target.parentNode.removeChild(x)}else{a.target.parentNode.removeChild(document.getElementById("placeholder"))}if(z<d){if(a.target.parentNode.lastChild!==a.target){a.target.parentNode.insertBefore(e,a.target.nextSibling)}else{a.target.parentNode.appendChild(e)}}else{a.target.parentNode.insertBefore(e,a.target)}y=Array.from(a.target.parentNode.children);z=y.indexOf(e)})}},{key:"initAddForm",value:function(){var a=g(regeneratorRuntime.mark(function a(){var d=this,e,f;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:e=document.querySelector("#id_mqaddbutton");this.vmiTestAndSaveContainer=document.querySelector(".test-box");this.controls=new D(this.controlsWrapper);this.controls.bindInput(this.vmiTest);this.vmiButton.parent.querySelector(".invalid-feedback").textContent="Button is empty or invalid!";this.vmiExpression.parent.querySelector(".invalid-feedback").textContent="Expression is empty or invalid!";e.addEventListener("click",function(a){a.preventDefault();a.stopPropagation();d.isSuccess=d.controls.add(d.buttonMathInput,d.expressionMathInput);if(A){d.buttonMathInput.latex("");d.expressionMathInput.latex("")}});if(!(0<this.templateId)){a.next=18;break}a.prev=8;a.next=11;return(0,c.getShortmathTemplate)(this.templateId);case 11:f=a.sent;f.forEach(this.controls.addAll.bind(this.controls));a.next=18;break;case 15:a.prev=15;a.t0=a["catch"](8);b.default.addNotification({message:a.t0,type:"error"});case 18:case"end":return a.stop();}}},a,this,[[8,15]])}));return function initAddForm(){return a.apply(this,arguments)}}()},{key:"initDeleteButton",value:function(){var a=g(regeneratorRuntime.mark(function a(){var b=this,c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=document.querySelector(".delete-icon");c.addEventListener("dragover",function(a){a.preventDefault();a.dataTransfer.dropEffect="move"});c.addEventListener("drop",function(a){a.preventDefault();var c=x.parentNode;if(null!==c){c.removeChild(x);if(null===c.firstElementChild){b.testMathInput.latex("")}}else{var d=document.getElementById("placeholder");if(null!==d){d.parentNode.removeChild(d)}}a.dataTransfer.clearData()});case 3:case"end":return a.stop();}}},a)}));return function initDeleteButton(){return a.apply(this,arguments)}}()},{key:"addSubmitButtonEventListener",value:function addSubmitButtonEventListener(){var a=this,b=document.querySelector("#id_submitbutton");b.addEventListener("click",function(){var b=[],c=a.controls.controls;a.controlsWrapper.querySelectorAll("button").forEach(function(a){var d=c[a.id];b.push({name:d.name,button:d.text,expression:d.command})});var d=JSON.stringify(b),e=document.querySelector("[name=\"templatestring\"]");e.value=d})}}]);return a}()});
//# sourceMappingURL=editor_page.min.js.map
